<div *ngIf="!selectedCustomer && !selectedSubscription && !selectedpositionCredit">
<div style="display: flex; justify-content: space-between; align-items: center">
  <h1 class="header-text">Customers</h1>
  <button
    mat-raised-button
    color="primary"
    class="top-right-corner"
    (click)="createCompany()"
    *appHasRole="['CompanyAdmin']"
  >
    <mat-icon>person_add</mat-icon> Add a Customer
  </button>
</div>

<div>
  <mat-form-field class="small" appearance="outline">
    <mat-label>Search Customer Name</mat-label>
    <input matInput type="text" (keyup)="applyFilter($event, 'CustomerName')" />
  </mat-form-field>
</div>

<div *ngIf="loading" class="loading-overlay">
  <div class="loading-content">
    <mat-progress-spinner
      mode="indeterminate"
      diameter="60"
      color="primary"
    ></mat-progress-spinner>
    <p>Loading customers, please wait...</p>
  </div>
</div>

<div *ngIf="!loading">
  <div class="sort-container" style="display: flex; justify-content: end; align-items: center;">
    <mat-form-field appearance="outline" class="small-input">
      <mat-select [(value)]="sortOrder" (selectionChange)="sortData()" panelClass="custom-dropdown-panel" [panelWidth]="'300px'" hideSingleSelectionIndicator>
        <mat-option value="asc">Sort By</mat-option>
        <mat-option *ngFor="let option of sortOptions" [value]="option.value">
          <mat-pseudo-checkbox [state]="sortOrder === option.value ? 'checked' : 'unchecked'"></mat-pseudo-checkbox>
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>
  <mat-card class="card">
    <div class="table-container">
      <table
        mat-table
        [dataSource]="dataSource"
        class="trackers"
      >
      <ng-container *ngFor="let column of displayedColumns">
        <ng-container *ngIf="column !== 'Actions'">
          <ng-container [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef style="font-weight: bold">
              {{ column }}
            </th>
            <td mat-cell *matCellDef="let emp"
                [ngStyle]="column === 'LimitReached' ? { 'color': emp[column] ? 'red' : 'black'} : {}">
                {{ column === 'LimitReached' ? (emp[column] ? 'Yes' : 'No') : emp[column] }}
            </td>

          </ng-container>
        </ng-container>
      </ng-container>
      
      <ng-container matColumnDef="Actions">
        <th mat-header-cell *matHeaderCellDef style="font-weight: bold">
          Actions
        </th>
        <td mat-cell *matCellDef="let emp">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="viewCompanyDetails(emp)">View Details</button>
            <button mat-menu-item (click)="openCompanyForm(emp)">Edit Details</button>
            <button mat-menu-item (click)="addSubscriptionClick(emp)">Add Subscription</button>
            <button mat-menu-item (click)="addPositionCreditClick(emp)">
              Add Position Credits
            </button>
            <button mat-menu-item>Delete Company</button>
            <button mat-menu-item>Block Company</button>
          </mat-menu>
        </td>
      </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let emprow; columns: displayedColumns"></tr>
      </table>
    </div>
  </mat-card>
</div>

<mat-paginator
  #paginator
  [pageSize]="pageSize"
  [pageSizeOptions]="[5, 10, 20]"
></mat-paginator>
</div>

<!-- Position Credit Add View -->
<div *ngIf="selectedpositionCredit">
  <div class="subscription-container">
    <div class="details-header-container">
      <button mat-icon-button (click)="goBack()" class="go-back-button">
        <mat-icon>arrow_back_ios</mat-icon>
      </button>
      <h2 class="details-header">Add Position Credit</h2>
    </div>

    <form [formGroup]="positionCreditForm">
      <!-- First Row: Billing Date & Expiry Date -->
      <div class="checkbox-container">
        <mat-checkbox formControlName="noLimitOnCredit">
          No Limit On Credit
        </mat-checkbox>
      </div>

      <div style="display: flex; gap: 20px">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Customer Name</mat-label>
          <mat-select formControlName="customerName">
            <mat-option *ngFor="let type of customerNames" [value]="type">
              {{ type }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Position Credit</mat-label>
          <input matInput formControlName="positionCredit" />
        </mat-form-field>
      </div>

      <!-- Third Row: Description (Full Width) -->
      <div class="form-row">
        <mat-form-field class="full-width textarea-container" appearance="outline">
          <mat-label>Description</mat-label>
          <textarea 
            matInput 
            rows="3" 
            formControlName="description" 
            (input)="updateCharCount('positionCredit')" 
            [maxlength]="maxCharLimit">
          </textarea>
          <div class="char-counter">{{ charCount }} / {{ maxCharLimit }}</div>
        </mat-form-field>
      </div>

      <!-- Submit Button -->
      <div class="button-container">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          class="submit-btn"
          (click)="savePositionCredit()"
        >
          Submit
        </button>
      </div>
    </form>
  </div>

  <div
    class="sort-container"
    style="
      display: flex;
      justify-content: end;
      align-items: center;
      margin-bottom: 10px;
    "
  >
    <mat-icon [matMenuTriggerFor]="filterMenu" style="cursor: pointer"
      >filter_alt</mat-icon
    >
  </div>

  <mat-menu #filterMenu="matMenu" class="custom-menu">
    <div class="custom-menu-items">
      <mat-accordion (click)="$event.stopPropagation()">
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>Position Credit Type</mat-panel-title>
          </mat-expansion-panel-header>

          <div *ngFor="let position of positionCreditData">
            <mat-checkbox
              (change)="
                toggleSelection(
                  'positionCreditType',
                  position.positionCreditType,
                  $event
                )
              "
            >
              {{ position.positionCreditType }}
            </mat-checkbox>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
      <mat-accordion (click)="$event.stopPropagation()">
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>User Login Id</mat-panel-title>
          </mat-expansion-panel-header>

          <div *ngFor="let position of positionCreditData">
            <mat-checkbox
              (change)="toggleSelection('user', position.user, $event)"
            >
              {{ position.user }}
            </mat-checkbox>
          </div>
        </mat-expansion-panel>
      </mat-accordion>

      <p>Date & Time</p>
      <div class="date-picker-container">
        <mat-form-field appearance="outline" class="date-picker">
          <mat-label>From</mat-label>
          <input
            matInput
            [matDatepicker]="fromPicker"
            (dateChange)="onDateChange($event, true)"
          />
          <mat-datepicker-toggle
            matIconSuffix
            [for]="fromPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #fromPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="date-picker">
          <mat-label>To</mat-label>
          <input
            matInput
            [matDatepicker]="toPicker"
            (dateChange)="onDateChange($event, false)"
          />
          <mat-datepicker-toggle
            matIconSuffix
            [for]="toPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #toPicker></mat-datepicker>
        </mat-form-field>
      </div>
    </div>
  </mat-menu>

  <table
    mat-table
    [dataSource]="filteredPositionCreditData"
    class="subscription-table"
  >
    <ng-container matColumnDef="sNo">
      <th mat-header-cell *matHeaderCellDef>S.No</th>
      <td mat-cell *matCellDef="let element">{{ element.sNo }}</td>
    </ng-container>

    <ng-container matColumnDef="positionCredit">
      <th mat-header-cell *matHeaderCellDef>Position Credit</th>
      <td mat-cell *matCellDef="let element">{{ element.positionCredit }}</td>
    </ng-container>

    <ng-container matColumnDef="positionCreditType">
      <th mat-header-cell *matHeaderCellDef>Position Credit Type</th>
      <td mat-cell *matCellDef="let element">
        {{ element.positionCreditType }}
      </td>
    </ng-container>

    <ng-container matColumnDef="DateAndTime">
      <th mat-header-cell *matHeaderCellDef>Date And Time</th>
      <td mat-cell *matCellDef="let element">{{ element.DateAndTime }}</td>
    </ng-container>

    <ng-container matColumnDef="user">
      <th mat-header-cell *matHeaderCellDef>User</th>
      <td mat-cell *matCellDef="let element">{{ element.user }}</td>
    </ng-container>

    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef>Description</th>
      <td mat-cell *matCellDef="let element">{{ element.description }}</td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="positionCreditTableColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: positionCreditTableColumns"></tr>
  </table>
</div>

<!-- Subscription View -->
<div *ngIf="selectedSubscription">
  <div class="subscription-container">
    <div class="details-header-container">
      <button mat-icon-button (click)="goBack()" class="go-back-button">
        <mat-icon>arrow_back_ios</mat-icon>
      </button>
      <h2 class="details-header">Add Subscription</h2>
    </div>

      <form [formGroup]="subscriptionForm">
        
        <!-- First Row: Billing Date & Expiry Date -->
        <div class="form-row">
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Billing Date</mat-label>
            <input matInput [matDatepicker]="billingDatePicker" formControlName="billingDate">
            <mat-datepicker-toggle matIconSuffix [for]="billingDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #billingDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Expiry Date</mat-label>
            <input matInput [matDatepicker]="expiryDatePicker" formControlName="expiryDate">
            <mat-datepicker-toggle matIconSuffix [for]="expiryDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #expiryDatePicker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Second Row: Mode of Payment & Payment Date -->
        <div class="form-row">
          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Mode of Payment</mat-label>
            <input matInput formControlName="paymentMode" type="text">
          </mat-form-field>

          <mat-form-field class="half-width" appearance="outline">
            <mat-label>Payment Date</mat-label>
            <input matInput [matDatepicker]="paymentDatePicker" formControlName="paymentDate">
            <mat-datepicker-toggle matIconSuffix [for]="paymentDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #paymentDatePicker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Third Row: Description (Full Width) -->
        <div class="form-row">
          <mat-form-field class="full-width textarea-container" appearance="outline">
            <mat-label>Description</mat-label>
            <textarea 
              matInput 
              rows="3" 
              formControlName="description" 
              (input)="updateCharCount('subscription')" 
              [maxlength]="maxCharLimit">
            </textarea>
            <div class="char-counter">{{ charCount }} / {{ maxCharLimit }}</div>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-checkbox formControlName="blockCompany">Block Company on expiry</mat-checkbox>
        </div>
        

        <!-- Submit Button -->
        <div class="button-container">
          <button 
            mat-raised-button 
            color="primary" 
            type="submit" 
            class="submit-btn"
            (click)="saveSubscription()"
          >
            Save
          </button>
        </div>
      </form>
  </div>
  <table mat-table [dataSource]="subscriptionData" class="subscription-table">
    <ng-container matColumnDef="sNo">
      <th mat-header-cell *matHeaderCellDef> S.No </th>
      <td mat-cell *matCellDef="let element"> {{ element.sNo }} </td>
    </ng-container>

    <ng-container matColumnDef="companyName">
      <th mat-header-cell *matHeaderCellDef> Company Name </th>
      <td mat-cell *matCellDef="let element"> {{ element.companyName }} </td>
    </ng-container>

    <ng-container matColumnDef="subscriptionDate">
      <th mat-header-cell *matHeaderCellDef> Subscription Date </th>
      <td mat-cell *matCellDef="let element"> {{ element.subscriptionDate }} </td>
    </ng-container>
  
    <ng-container matColumnDef="billingDate">
      <th mat-header-cell *matHeaderCellDef> Billing Date </th>
      <td mat-cell *matCellDef="let element"> {{ element.billingDate }} </td>
    </ng-container>
  
    <ng-container matColumnDef="expiryDate">
      <th mat-header-cell *matHeaderCellDef> Expiry Date </th>
      <td mat-cell *matCellDef="let element"> {{ element.expiryDate }} </td>
    </ng-container>

    <ng-container matColumnDef="blockOnExpiry">
      <th mat-header-cell *matHeaderCellDef> Block On Expiry</th>
      <td mat-cell *matCellDef="let element"> {{ element.blockOnExpiry }} </td>
    </ng-container>
  
    <ng-container matColumnDef="modeOfPayment">
      <th mat-header-cell *matHeaderCellDef> Mode of Payment </th>
      <td mat-cell *matCellDef="let element"> {{ element.modeOfPayment }} </td>
    </ng-container>
  
    <ng-container matColumnDef="paymentDate">
      <th mat-header-cell *matHeaderCellDef> Payment Date </th>
      <td mat-cell *matCellDef="let element"> {{ element.paymentDate }} </td>
    </ng-container>

    <ng-container matColumnDef="user">
      <th mat-header-cell *matHeaderCellDef> User </th>
      <td mat-cell *matCellDef="let element" style="text-decoration: underline;"> {{ element.user }} </td>
    </ng-container>
  
    <ng-container matColumnDef="description">
      <th mat-header-cell *matHeaderCellDef> Description </th>
      <td mat-cell *matCellDef="let element"> {{ element.description }} </td>
    </ng-container>
  
    <tr mat-header-row *matHeaderRowDef="subscriptionTableColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: subscriptionTableColumns;"></tr>
  </table>
</div>

<!-- Company Details View -->
<div *ngIf="selectedCustomer">
  <div class="details-container">
    <div class="details-header-container">
      <button mat-icon-button (click)="goBack()" class="go-back-button">
        <mat-icon>arrow_back_ios</mat-icon>
      </button>
      <h2 class="details-header">View Customer Details</h2>
    </div>

    <div class="details-grid">
      <div class="detail-item">
        <span class="detail-key">Company Name</span>
        <span class="detail-value">: {{ selectedCustomer?.CustomerName }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Company Type</span>
        <span class="detail-value">: {{ selectedCustomer?.CompanyType }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">GST Number</span>
        <span class="detail-value">: {{ selectedCustomer?.GSTNumber }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Director Name</span>
        <span class="detail-value">: {{ selectedCustomer?.DirectorName }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Contact Person Name</span>
        <span class="detail-value">: {{ selectedCustomer?.ContactPersonName }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Contact Person Number</span>
        <span class="detail-value">: {{ selectedCustomer?.ContactPersonNumber }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Contact Email</span>
        <span class="detail-value">: {{ selectedCustomer?.ContactEmail }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Login Email Id</span>
        <span class="detail-value">: {{ selectedCustomer?.LoginEmailId }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Address</span>
        <span class="detail-value">: {{ selectedCustomer?.Address }}</span>
      </div>
      <div class="detail-item">
        <span class="detail-key">Description</span>
        <span class="detail-value">: {{ selectedCustomer?.Description }}</span>
      </div>
    </div>
  </div>
</div>